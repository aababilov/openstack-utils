#!/bin/sh -e

get_script()
{
	return
	rm -f $1
	wget $REMOTE_PATH/$1 && mv $1 /usr/local/bin/$1
	chmod +x /usr/local/bin/$1
}

TMP_DIR=/var/tmp/openstack

mkdir -p $TMP_DIR
cd $TMP_DIR

REMOTE_PATH=ftp://172.31.0.13/pub/

get_script erase-openstack

if false && ! yum install openstack-repo; then
    VERSION=4
    OS_REPO=openstack-repo-2011.3-0.${VERSION}.noarch.rpm
    wget http://yum.griddynamics.net/yum/diablo-${VERSION}/openstack/$OS_REPO
    rpm -i $TMP_DIR/$OS_REPO
fi

get_script os-all-services
get_script osng-services

yum -y install libvirt
chkconfig libvirtd on
service libvirtd start

yum -y install openstack-nova-node-full
echo '--vlan_interface=eth0' >> /etc/nova/nova.conf

service mysqld start
chkconfig mysqld on
service rabbitmq-server start
chkconfig rabbitmq-server on
mysqladmin -uroot password nova

#regen db
DB_NAME=nova
DB_USER=nova
DB_PASS=nova
PWD=nova

CC_HOST="127.0.0.1 $(hostname) localhost" # IPv4 address
#HOSTS='node1 node2 node3' # compute nodes list

mysqladmin -uroot -p$PWD -f drop nova || true
mysqladmin -uroot -p$PWD create nova

for h in $HOSTS $CC_HOST; do
        echo "GRANT ALL PRIVILEGES ON $DB_NAME.* TO '$DB_USER'@'$h' IDENTIFIED BY '$DB_PASS';" | mysql -uroot -p$DB_PASS mysql
done
echo "GRANT ALL PRIVILEGES ON $DB_NAME.* TO $DB_USER IDENTIFIED BY '$DB_PASS';" | mysql -uroot -p$DB_PASS mysql
echo "GRANT ALL PRIVILEGES ON $DB_NAME.* TO root IDENTIFIED BY '$DB_PASS';" | mysql -uroot -p$DB_PASS mysql

nova-manage db sync

os-all-services start || true

#create project
nova-manage user admin admin
nova-manage project create aproject admin
nova-manage project zipfile aproject admin
rm -f novarc
unzip nova.zip novarc
source ./novarc

nova-manage network create my_network_0 10.10.0.0/16 || true

# prepare to run instance
INITRD_FILE=initrd-2.6.18-238.el5-virtio.img
KERNEL_FILE=vmlinuz-2.6.18-238.el5
IMAGE_FILE=rootfs.qcow2

IMG_PATH=$REMOTE_PATH/RHEL56/

for i in $INITRD_FILE $KERNEL_FILE $IMAGE_FILE; do
    if [ ! -r  $i ]; then
        wget $IMG_PATH/$i
    fi
done

glance add name=ramdisk disk_format=ari container_format=ari is_public=True < "$INITRD_FILE"
glance add name=kernel disk_format=aki container_format=aki is_public=True < "$KERNEL_FILE"
glance add name=lucid_ami disk_format=ami container_format=ami is_public=True ramdisk_id=1 kernel_id=2 < "$IMAGE_FILE"
glance index

exit
#setup keystone
osng-services stop
yum -y install openstack-keystone
(cd /etc/nova && mv api-paste.ini api-paste.ini.bak && cp api-paste.ini.keystone.example api-paste.ini)
get_script keystone-sampledata
sudo -u keystone /usr/local/bin/keystone-sampledata

IPADDR=$(/sbin/ifconfig | grep 'eth[0-9]*' -A 1 | grep 'inet addr'| sed 's/ *inet addr://'| sed 's/ *Bcast.*//')
echo "actual ip address: $IPADDR"
sed -i "s/127.0.0.1/$IPADDR/" /etc/nova/*.{ini,conf}

#setup dashboard
yum -y install openstack-dashboard

osng-services start
